---
title: "College's predicted profit by sport"
author: "Standard Deviants - Ava Exelbirt, Yura Heo, Claire Li"
date: "11/7/2023"
format: pdf
execute: 
  warning: false
  message: false
  echo: false
editor: visual
---

```{r}
#| label: model-stats-function
calc_model_stats <- function(x) {
  glance(extract_fit_parsnip(x)) |>
    select(adj.r.squared, AIC, BIC)
}
```

```{r}
#| label: load packages and data
install.packages("reshape2")

library(tidyverse)
library(tidymodels)
library(skimr)
library(knitr)
library(rms)
library(patchwork)
library(kableExtra)
library(reshape2)

sports <- read.csv("data/sports.csv")
```

#### Introduction and data

In our research project, we aim to investigate and understand the factors influencing the profit generated by collegiate sport, specifically basketball, in the school year 2019 to 2020. We will be utilizing a dataset sourced from Tidy Tuesday, which provides a comprehensive collection of observations related to collegiate sports, including information about the schools, classifications, sport types, and various quantitative variables describing the sport players and the schools' financial investment in sports programs in the dataset called "sports.csv". Our primary motivation for this research is to gain insights into the determinants of collegiate basketball profit, which can be of significant interest to educational institutions and further local policy makers and sports enthusiasts. Understanding the factors that contribute to profit generation in collegiate basketball sports can inform decision-making, investment strategies in sports, and future planning for universities and colleges involved in sports programs. We chose to do profit as our response variable because expenditures and revenue are closely related, so expenditure would overpower the other predictor variables if we were to predict revenue or expenditure. Therefore, we will create a new variable profit calculated from revenue minus expenditures and predict this. 

Our primary research question is as follows: **In the school year 2019 to 2020, how can we predict the profit (revenue- expenditure) in USD of the collegiate sport basketball using participation rate, school sector name, gender ratio, total count of students, percent of expenditures towards women's sports, and school classification name**.

Our hypothesis is as follows: **Participation rate, sector name, and gender ratio will be the most influential predictors for the total profit generated by the collegiate sport basketball in USD.**

The data set was taken from TidyTuesday and was originally scraped from Equity in Athletics Data Analysis (EADA), a sector of the US Department of Education. The data is available on an online database found on the (EADA) website1.

This data is submitted annually from colleges to the EADA. All co-educational postsecondary institutions that receive Title IV funding that have intercollegiate athletics programs are required by the Equity in Athletics Disclosure Act to submit this data. The original data files are also created immediately after the data collection for each school. These data are collected annually starting from 2003 to 2022, but for our specific data analysis we will only look at data taken from the school year of 2019 by cleaning the data to a new csv file which we will use for the rest of the project. The csv file from Tidy Tuesday contains thousands of observations from years 2015-2019, but we have adjusted the data file to only include the year 2019 and will filter the data to only include basketball as a sport, as this is our population we are analyzing.

The dataset we will use from the data scraped on Tidy Tuesday include many observations regarding collegiate sports. These observations include variables such as the name of the city which a school is in, the state, the school name, the classification of the school (like whether it is NCAA Division I, II, or III), the type/sector name of the school (like 4 year accredited university), sport, and many quantitative variables regarding characteristics about the specific school and their collegiate spending. Most of the quantitative variables are split between men and women, having two different observations for the same variable. For example, there is total male population, total female population, participation rate of women, participation rate of men, revenue for men, revenue for women, expenditures for men, and expenditures for women. There are also observations for the total amount for each of these above variables which includes both men and women; for example, total expenditures for both men and women together. The observations are therefore both quantitative and categorical and measure characteristics of different school's spending, revenue, populations, locations, and sports.

The key variables we will use are **participation rate** which is the total percentage of men and women students who participate in sports, **sector school name** which is the type of school for example, public, 4-year or above, **gender ratio** which is the male population count divided by female population count, **total count of students** which is the total amount of students enrolled in the college, women expenditure percent which is the percentage of expenditures that goes towards woman's sports (which we calculated by taking a school's expenditures of women and dividing it by the school's total expenditures), **school classification name** which is a school\\'s sports classification for example NCAA Division I-FCS. Then, our response variable is **profit** which is calculated by the total revenue of the school for basketball minus the expenditures of the school for basketball.

For data cleaning, we need to filter for observations that have `Basketball` as the sports and filter out missing values. we also need to filter out observations that have missing values of the predictor variables we need in the model. We need to create new variables by mutation to turn variables involving revenue and expenditure into the unit of millions and total student count into the unit of hundreds, so that we can get larger coefficients for better modeling. We create the new response variable of profit and new predictor variable of woman's expenditure percent.

```{r new-data, echo = FALSE}
basketball <- sports |>
  filter(sports == "Basketball") |>
  mutate(total_rev_mill = total_rev_menwomen / 1000000,
         total_exp_mill = total_exp_menwomen / 1000000,
         ef_total_count = ef_total_count /100) |>
  mutate(profit = total_rev_mill - total_exp_mill, 
         perc_wom_exp = exp_women/total_exp_menwomen)

```

**Distribution of the response variable: total profit generated by college basketball**

```{r response-dist}
 profit1 <- basketball |>
  filter(profit > 0) |>
  ggplot(aes(x = profit)) +
  geom_histogram(fill = "dark green") +
  scale_x_log10() +
  labs(title = "Distribution of Positive Profit \n (in log million $)",
       x = "Log 10 of the Positive Profits", y = "Count") +
  theme(plot.title = element_text(size = 10))

profit2 <- basketball |>
  filter(profit < 0) |>
  ggplot(aes(x = abs(profit))) +
  geom_histogram(fill = "red") +
  scale_x_log10() +
  labs(title = "Distribution of Profit Losses \n (in log million $)",
       x = "Log 10 of the Negative Profits", y = "Count") +
  theme(plot.title = element_text(size = 10))

totalprofit <- basketball |>
  ggplot(aes(x = profit)) +
  geom_histogram(binwidth = 10) +
  labs(title = "Distribution of Profit (in million $)",
       x = "Profit (in million $)", y = "Count") +
  theme(plot.title = element_text(size = 10))

profit1 + profit2 / totalprofit

profit_eda <- basketball |>
  skim(profit) |>
  select(-skim_type, -skim_variable, -complete_rate,
         - numeric.hist) |>
  print(width = Inf) 

```

The distribution of profit is approximately normally distributed with a slight right skew. However, many observations centered around 0\$ in profit. The median of the data is at 0\$, and the mean is about 0.027 million USD. Since the response is approximately normal, we can use the mean as the center of the data. The range is from -9.6738 million USD to 16.8938 million USD. We also split up the distribution into positive and negative profits and took the log of the x axis so better see a more detailed distribution. It seems that positive profits is normally distributed while negative profits are left skewed. There are 57 missing values of profit.

**Distributions of total amount of students (potential quantitative predictor variable) and type of school (potential categorical predictor variable)**

```{r pred-dist, echo = FALSE, fig.width = 7, fig.height = 3}
p_exp <- basketball |>
  ggplot(aes(x = ef_total_count, fill = sector_name)) +
  geom_histogram() +
  guides(shape = guide_legend(override.aes = list(size = 3)),
         color = guide_legend(override.aes = list(size = 3))) +
  theme(legend.title = element_text(size = 3), 
        legend.text  = element_text(size = 3)) +
  labs(title = "Distribution of Total Amount of Students \n(in hundreds)",
       x = "Number of Students (in hundreds)", 
       y = "Count", 
       fill = "School Type") +
  theme(plot.title = element_text(size = 10)) + 
  xlim(0, 450)

p_type <- basketball |>
  ggplot(aes(x = str_wrap(sector_name, width = 10))) +
  geom_bar() +
  labs(title = "Distribution of Types \n of School",
       x = "Types of school", y = "Count") + 
   theme(plot.title = element_text(size = 10), 
         axis.text.y = element_text(size = 5), 
         axis.text.x = element_text(angle = 45, size = 5))
        

p_exp + p_type

t_exp <- basketball |>
  skim(ef_total_count) |>
  select(-skim_type, -skim_variable, -complete_rate,
         - numeric.hist) |> 
  print(width = Inf) 

cat_statistics <- function(x) {
  nmiss <- sum(is.na(x))
  n     <- table(x)
  p     <- prop.table(n)
  OUT   <- cbind(n, p)
  nmiss <- c(nmiss, rep(NA, nrow(OUT)-1))
  OUT   <- cbind(OUT, nmiss)
  return(OUT)
}

cat_statistics(basketball$sector_name)

```

The distribution of total amount of students on college sports is right-skewed with most of the amount of student values in the lower range, while a number of observations have very high values that make them outliers. Given the apparent skewness, the center is the median of 2,005.5 students. Since the distribution is skewed, the IQR is used as a more reliable measure of spread which is Q3 - Q1 = 4,633 - 1,060.25 = 3,572.75 students. You can also see that most of the schools with very high number of students are public, 4 year or above colleges.

There are 5 types of schools. Private for-profit, 2-year and private nonprofit, 2-year have low numbers of observations. Private nonprofit, 4-year or above, public, 2 year, and public, 4-year or above have comparably higher number of observations than the other two, with private nonprofit, 2-year having the highest number of observations. There is 1 missing value in types of school.**\
**

**Relationship between Profit and a Categorical and Quantitative Predictor**

```{r profit-vs-part, echo = FALSE, fig.width = 7, fig.height = 3}
basketball |>
  ggplot(aes(x = sector_name, y = profit)) +
  geom_boxplot() +
  labs(title = "Profit vs. Type of School",
       x = "Type of School", 
       y = "Profit (in million $)") +
  theme(plot.title = element_text(size = 10)) +
  coord_flip()

basketball |>
  ggplot(aes(x = sum_partic_men, y = profit, color = classification_name)) +
  geom_point() +
  labs(title = "Profit vs. Men's Participation \n Rate and Classification Name",
  x = "Men's Participation Rate (%)", y = "Profit (in million $)") +
   theme(plot.title = element_text(size = 10))

basketball |>
  ggplot(aes(x = sum_partic_women, y = profit, color = classification_name)) +
  geom_point() +
  labs(title = "Profit vs. Women's Participation \n Rate and Classification Name",
  x = "Women's Participation Rate (%)", y = "Profit (in million $)") +
   theme(plot.title = element_text(size = 10))

```

Looking at the relationships above, it seems that the medians of each type of school's profit is around \$0. We can also see that Public, 4 year or above colleges have the highest recorded profit in USD, and that Private nonprofit, 4 year or above colleges have the lowest profit in USD.

Looking at the participation rate graphs, there seems to be slightly more participation of women than of men, as many of the data points are more spread out to the right of the graph for women while there is a conglomerate of data points centered around 20% for men's participation rate. There seems to be a very weak almost negative linear relationship between participation rate versus profit, as most of the data points are centered around \$0 profit regardless of participation rate. However, looking at the mens participation rate specifically, it seems schools classified with sports as NCAA Division I-FBS have the highest profits and highest range of profits. Schools classified as NAIA Division II and NCAA Division II without football seem to have high mens participation rates. For womens participation rate, it shows the same thing as mens, however there tends to be greater participation rate of women than men in NCAA Division I-FBS schools.

**A potential interaction effect between total number of student and type of school**

```{r interact, echo = FALSE, fig.width = 7}
basketball |>
  ggplot(aes(x = ef_total_count, y = profit, color = sector_name)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  scale_color_discrete(name = "Type of school") +
  labs(title = "Profit vs. Total Number of Students and School Type",
       x = "Total number of students (in hundreds)", y = "Total profit (in million $)") + 
   theme(plot.title = element_text(size = 10), 
         axis.title.y = element_text(size = 8), 
         axis.title.x = element_text(size = 8))
```

The lines are not parallel indicating there is an interaction effect. The slope of total number of student differs based on the type of school.

#### Methodology

We plan to use a multiple linear regression to predict the profit (revenue - expenditure) in USD of the collegiate sport basketball using participation rate, school sector name, gender ratio, percentage of women expenditure, total count of students, and school classification name. For the predictor gender ratio, we will mutate the data and divide the total male student count by total female student count. For the predictor percentage of women expenditure, we will mutate the data and divide a school's woman's expenditure by total expenditure.

For the response variable, we decided to predict the profit, subtracting the expenditure variable from the revenue variable, instead of predicting the revenue variable and using the expenditure variable as a predictor because we anticipate that the revenue variable and the expenditure variable will have strong correlations. Expenditure will be strongly correlated with the revenue of the sport basketball because schools often allocate significant financial resources to their sports programs, scholarships, and marketing. As these investments increase, the expectation is that they will have a direct impact on the overall revenue generated through different resources such as ticket sales. 

For this reason, we decided that using expenditure to predict the revenue will not produce a meaningful result in choosing the best predictors as expenditure may already significantly affect the revenue, muting the effects of all the other predictors. 

For the predictors, we anticipate that **participation rate** will be a key predictor of the total profit of the sport basketball because schools may allocate more money to this sport if there is more participation from the students. We also expect that the type of school **(sector name)** will be a strong predictor of profit because different types of schools have varying levels of resources, alumni support, and participation rates in sports depending on school size and program. **Gender ratio** is another predictor to consider because sports could be hugely dependent on the demographics of players. Lastly, we included woman expenditure percentage as a predictor because we were curious to see if the proportion of spending on woman's sports would influence the sports profit of a school.

Additionally, we anticipate interaction effects which we will do further analysis in our results. Specifically, we believe the participation rate and the school sector type will have a correlation. This is because we expect the participation rate to be very dependent on the levels of investment, competitive levels, institutional culture, and student demographics which vary based on the type of institution(sectorname). 

We first check the model's comditions.

```{r clean-data}
basketball_m <- basketball |>
  mutate(gender_r = ef_male_count / ef_female_count,
         total_partc = ((ef_male_count * sum_partic_men/100) + (ef_female_count * sum_partic_women/100))/ef_total_count)
```

*Checking Model Conditions:*

```{r mult_fit}
basketball_mult_fit <- linear_reg() |>
  set_engine("lm") |>
  fit(profit ~ total_partc + sector_name + gender_r
      + ef_total_count + perc_wom_exp + classification_name, data = basketball_m)

basketball_aug_mult <- augment(basketball_mult_fit$fit)
```

```{r check-resid}
ggplot(data = basketball_aug_mult, aes(x = .fitted, y = .resid)) + 
  geom_point() +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  labs(x = "Fitted values", 
       y = "Residuals", 
       title = "Residuals vs. fitted")
```

Constant variance is met because there is an even amount of residuals above and below the horizontal line. Linearity may not be met. We can see that there is a conglomerate of points that shape a almost negative line around the y intercept. However, there is a random scatter of points around this. This should be kept in mind and show that a linear model may not be the best regression model to use.

```{r normal-res}
ggplot(data = basketball_aug_mult, aes(x = .resid)) +
  geom_histogram() +
  labs(x = "Residuals", 
       y = "Count", 
       title = "Distribution of residuals")
```

We can see the normality condition is satisfied as the residuals are normally distributed and the sample has more than 30 observations. Independence is also satisfied because of how the data was taken. Collegiate information about one school is independent of another school.

To avoid overfitting the data, we then split the dataset into the training and the test data, and we used cross validation using 20 folds. Then we used our recipe to fit our models. Using the models, we calculated AIC and BIC to evaluate each model fit.

Log transform

```{r}
basketball_m <- basketball_m |>
  mutate(log_profit = case_when(
    sign(profit) == 1 ~ log(profit),
    sign(profit) == -1 ~ -log(-profit)
  ))

```

```{r}
basketball_mult_fit_log <- linear_reg() |>
  set_engine("lm") |>
  fit(log_profit ~ total_partc + sector_name + gender_r
      + ef_total_count + perc_wom_exp + classification_name, data = basketball_m)

basketball_aug_mult_log <- augment(basketball_mult_fit_log$fit)
ggplot(data = basketball_aug_mult_log, aes(x = .fitted, y = .resid)) + 
  geom_point() +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  labs(x = "Fitted values", 
       y = "Residuals", 
       title = "Residuals vs. fitted")
```

```{r split}
set.seed(2023)

split <- initial_split(basketball_m, prop = 0.75)
train <- training(split)
test <- testing(split)

folds <- vfold_cv(train, v = 20)

spec <- linear_reg() |>
  set_engine("lm")

```

To prepare the variables for our analysis, we plan to use a recipe. First, we plan to drop all the NA values using `step_naomit()`. We decided to drop NA values to ensure that the values we do use are accurate. For example, the data set has observations with NA values in women's participation rate. However, when the sum participation rate for women is calculated, the data set represents this sum with 0. This 0 can skew the regression model when the true participation rate of women may not be 0. Since we are using total participation rate in our model, it is best to drop NA values. Also, considering that the data set has 775 observations after all NA's are dropped, we still have a lot of reliable data to use for modeling. Then, we plan to use `step_zv()` to remove all predictors that contain only a single value. We plan to create dummy variables using `step_dummy()` for all nominal predictors which are Classification name and Sector name. Lastly, we will be using `step_center()` to mean center our quantitative predictors.

```{r recipe}
rec1 <- recipe(log_profit ~ total_partc + sector_name + gender_r
                + ef_total_count + classification_name + perc_wom_exp, 
                    data = train) |>
  step_naomit() |>
  step_other(classification_name, threshold = 50, other = "Other") |>
  step_center(total_partc, gender_r, ef_total_count) |>
  step_dummy(all_nominal_predictors()) |>
  step_zv(all_predictors())

wflow1 <- workflow() |>
  add_model(spec) |> 
  add_recipe(rec1) 

fit_rs1 <- wflow1 |>
  fit_resamples(resamples = folds,
                control = control_resamples(extract = calc_model_stats))

```

```{r AIC-BIC}
collect_metrics(fit_rs1, summarize = TRUE)

map_df(fit_rs1$.extracts, ~ .x[[1]][[1]]) |> 
  summarise(mean_adj_rsq = mean(adj.r.squared), 
            mean_aic = mean(AIC), 
            mean_bic = mean(BIC))

```

```{r recipe-two}
rec2 <-  recipe(log_profit ~ total_partc + gender_r
                + ef_total_count + classification_name + perc_wom_exp, 
                    data = train) |>
  step_naomit() |>
  step_other(classification_name, threshold = 50, other = "Other") |>
  step_center(total_partc, gender_r, ef_total_count) |>
  step_dummy(all_nominal_predictors()) |>
  step_zv(all_predictors())

wflow2 <- workflow() |>
  add_model(spec) |> 
  add_recipe(rec2) 

fit_rs2 <- wflow2 |>
  fit_resamples(resamples = folds,
                control = control_resamples(extract = calc_model_stats))

```

```{r metric-two}
collect_metrics(fit_rs2, summarize = TRUE)

map_df(fit_rs2$.extracts, ~ .x[[1]][[1]]) |> 
  summarise(mean_adj_rsq = mean(adj.r.squared), 
            mean_aic = mean(AIC), 
            mean_bic = mean(BIC))

```

```{r recipe-three}
rec3 <-  recipe(log_profit ~ total_partc + ef_total_count + gender_r + perc_wom_exp, 
                    data = train) |>
  step_naomit() |>
  step_center(total_partc, gender_r, ef_total_count, perc_wom_exp) |>
  step_dummy(all_nominal_predictors()) |>
  step_zv(all_predictors()) 

wflow3 <- workflow() |>
  add_model(spec) |> 
  add_recipe(rec3) 

fit_rs3 <- wflow3 |>
  fit_resamples(resamples = folds,
                control = control_resamples(extract = calc_model_stats))

```

Our final model uses the predictor of total participation rate, total count of students, gender ratio, and percentage of women expenditure.

```{r fit-model}
fit <- wflow3 |>
  fit(data = train)

tidy(fit) |>
  kable(digits = 3)
```

-   Model fit statistics

```{r metrics-final}
collect_metrics(fit_rs3, summarize = TRUE)

map_df(fit_rs3$.extracts, ~ .x[[1]][[1]]) |> 
  summarise(mean_adj_rsq = mean(adj.r.squared), 
            mean_aic = mean(AIC), 
            mean_bic = mean(BIC))

```

The final model has a AIC of 3879.914 and a BIC of 3911.228.

#### Results

Our initial model including total participation rate, school sector name, gender ratio, total student count, classification name, and profit by gender ratiopercentage of women expenditure has a AIC of 2003.095 and a BIC of 2062.62. When we reduce the sector name variable, the AIC decreases to 1995.288 and the BIC decreases to 2037.56. We choose our final model that further reduce the classification name variable since it has the lowest AIC and BIC. We decide not to further reduce the terms in the model to have sufficient predictor variables for the response variable.

-   Model diagnostics

```{r vif}
fit <- extract_fit_parsnip(fit)

vif(fit$fit)
```

There is no variable with $VIF > 10$ that indicates concerning multicollinearity, so no apparent issue with multicollinearity is found.

```{r find-rmse}
train_pred <- predict(fit, train) |>
  bind_cols(train)

rmse(train_pred, truth = profit, estimate = .pred)

test_pred <- predict(fit, test) |>
  bind_cols(test)

rmse(test_pred, truth = profit, estimate = .pred)
```

The RMSE for the training data which is 1.077032 while the RMSE for testing data is 0.7771352. Since we have a reasonably small difference in the RMSE, there is no apparent sign of model overfit. The model can generalize to new data.

-   Interaction Terms

To see if there are interaction terms, we will be using `step_interact()`. Because we ended up reducing the model taking out the sector name variable, we decided to check if there were any interaction effects between gender ratio and percentage of women expenditure with these variables having a connection with gender.

```{r}

rec3_int <-  recipe(log_profit ~ total_partc + ef_total_count + gender_r + perc_wom_exp, 
                    data = train) |>
  step_naomit() |>
  step_center(total_partc, gender_r, ef_total_count, perc_wom_exp) |>
  step_interact(terms = ~ gender_r:perc_wom_exp) |>
  step_dummy(all_nominal_predictors()) |>
  step_zv(all_predictors())

wflow3_int <- workflow() |>
  add_model(spec) |> 
  add_recipe(rec3_int) 

fit_rs3_int <- wflow3_int |>
  fit_resamples(resamples = folds,
                control = control_resamples(extract = calc_model_stats))


fit_int <- wflow3_int |>
  fit(data = train)

tidy(fit_int) |>
  kable(digits = 3)

```

Because the p value for `gender_r:perc_wom_exp` is about 0.56, we can conclude that there are no interaction effects between the two variables.

**Discussion + Conclusion**

Looking at each predictor's p values, the most significant predictor is total count of students with a p-value smaller than 0.05 where we can reject the null hypothesis that total count of students has no significant effect to profit. In terms of the coefficient of total count of students, we can give the following interpretation. For each hundred increase in the total count of students, the school's basketball profit is expected to increase by 0.002 million dollars. Furthermore, when comparing the AIC and BIC of multiple models to predict profit, we concluded that the best model to fit the data was the model that includes total participation rate, total student count, gender ratio, and percentage of women expenditure. Checking to see if there were any interaction terms between `gender_r` and `perc_wom_exp`by using `step_recipe()`, we concluded that there are no potential interaction effects.

While our study provides a comprehensive analysis of the factors influencing profit in collegiate basketball, there is room for improvement. One of the limitations of our research was that there may be more predictors outside the scope of our dataset that influences the profit of collegiate basketball. Also, the school year 2019-2020 was mainly when COVID 19 affected many schools and especially sports activities. We anticipate that the data collected during this timeline may not be applicable for other years without COVID.

In conclusion, we anticipate that the implications of our research predicting profit generation in collegiate basketball holds profound meaning in multiple domains such as in academia, sports management, and educational governance to foster an environment conducive to the holistic development of student-athletes. As a future direction, we would like to not just look at trends from the school year 2019-2020, but delve into longitudinal trends within collegiate basketball profitability by analyzing data spanning multiple seasons. We would also like to further our study by incorporating external factors that may influence profitability such as global events and changes in sports culture to get a nuanced perspective of our predictive model.
